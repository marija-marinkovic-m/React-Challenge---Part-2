import React from 'react';
import PropTypes from 'prop-types';

import imageChecker from '../util/imageChecker';
import makeCancelable from '../util/makePromiseCancelable';

const fallbackSrc = 'data:image/jpeg;base64,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';

class ImgPreload extends React.Component {
  _promise = null;
  state = {
    validatedSrc: null,
    loading: false
  }

  componentDidMount() {
    this.handleCheck();
  }

  componentDidUpdate(prevProps, prevState) {
    if (prevProps.src !== this.props.src && this.props.src) {
      this.handleCheck();
    }
  }

  componentWillUnmount() {
    this._promise && this._promise.cancel();
  }

  handleCheck = () => {
    this.setState({loading: true});
    this._promise = this.checkHandler(this.props.src);

    this._promise.promise
      .then(validated => this.setState({
        validatedSrc: validated.url,
        loading: false
      }))
      .catch((reason) => {
        console.log('isCanceled', reason.isCanceled);
        if (!reason.isCanceled) {
          this.setState({
            validatedSrc: fallbackSrc,
            loading: false
          })
        }
      });
  }

  checkHandler = (src) => {
    return makeCancelable(imageChecker(src));
  }

  render() {
    const { validatedSrc, loading } = this.state;
    return validatedSrc ? this.props.render(validatedSrc) : (loading ? 'loading fiugre..' : null);
  }
}

ImgPreload.propTypes = {
  render: PropTypes.func.isRequired,
  src: PropTypes.string.isRequired
}

export default ImgPreload;